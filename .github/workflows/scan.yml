name: Scan Connpass Events

on:
  # 定期実行は一時停止中（コスト確認のため）
  # schedule:
  #   - cron: '0 0 * * *'

  # 手動実行のみ
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (do not register to calendar)'
        required: false
        default: false
        type: boolean

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

      - name: Create config directory
        run: mkdir -p ~/.connpass-watcher

      - name: Setup config file
        env:
          CONNPASS_API_KEY: ${{ secrets.CONNPASS_API_KEY }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          INTEREST_KEYWORDS: ${{ vars.INTEREST_KEYWORDS }}
          EXCLUDE_KEYWORDS: ${{ vars.EXCLUDE_KEYWORDS }}
          INTEREST_PROFILE: ${{ vars.INTEREST_PROFILE }}
          MIN_PARTICIPANTS: ${{ vars.MIN_PARTICIPANTS }}
          LLM_ENABLED: ${{ vars.LLM_ENABLED }}
          LLM_PROVIDER: ${{ vars.LLM_PROVIDER }}
          LLM_MODEL: ${{ vars.LLM_MODEL }}
          GOOGLE_CALENDAR_ID: ${{ vars.GOOGLE_CALENDAR_ID }}
          COLOR_POPULAR: ${{ vars.COLOR_POPULAR }}
          COLOR_SPEAKER: ${{ vars.COLOR_SPEAKER }}
          MONTHS_AHEAD: ${{ vars.MONTHS_AHEAD }}
          WEEKS_AHEAD: ${{ vars.WEEKS_AHEAD }}
          HOURS_AHEAD: ${{ vars.HOURS_AHEAD }}
        run: |
          # hours_ahead > weeks_ahead > months_ahead の優先順
          if [ -n "${HOURS_AHEAD}" ]; then
            SEARCH_RANGE="hours_ahead: ${HOURS_AHEAD}"
          elif [ -n "${WEEKS_AHEAD}" ]; then
            SEARCH_RANGE="weeks_ahead: ${WEEKS_AHEAD}"
          else
            SEARCH_RANGE="months_ahead: ${MONTHS_AHEAD:-1}"
          fi

          # JSON配列を単一行にフォーマット（改行を除去）
          KEYWORDS_JSON=$(echo "${INTEREST_KEYWORDS:-[\"TypeScript\", \"Go\", \"AI\", \"LLM\", \"React\", \"Next.js\", \"Unreal Engine\", \"Unity\", \"CSS\", \"デザイン\", \"メタバース\", \"Rails\", \"Ruby\"]}" | tr -d '\n\r')
          EXCLUDE_JSON=$(echo "${EXCLUDE_KEYWORDS:-[\"輪読会\", \"読書会\", \"もくもく会\"]}" | tr -d '\n\r')

          cat > ~/.connpass-watcher/config.yaml << EOF
          connpass:
            api_key: "${CONNPASS_API_KEY}"
            prefectures:
              - tokyo
            include_online: true
            ${SEARCH_RANGE}

          interests:
            keywords: ${KEYWORDS_JSON}
            exclude_keywords: ${EXCLUDE_JSON}
            profile: "${INTEREST_PROFILE:-TypeScript, Go, AI/ML, Ruby, Rails, Unity, Unreal Engineなどに興味のあるエンジニア。LT登壇の機会を探している。}"
            min_participants: ${MIN_PARTICIPANTS:-50}

          speaker:
            check_participant_types: true
            check_cfp: true

          llm:
            enabled: ${LLM_ENABLED:-true}
            provider: ${LLM_PROVIDER:-google}
            model: ${LLM_MODEL:-gemini-2.0-flash}
            api_key: "${LLM_API_KEY}"

          google_calendar:
            enabled: true
            calendar_id: ${GOOGLE_CALENDAR_ID:-primary}
            color_popular: "${COLOR_POPULAR:-6}"
            color_speaker: "${COLOR_SPEAKER:-9}"

          schedule:
            cron: "0 9 * * *"
          EOF

      - name: Setup Google Calendar credentials
        if: ${{ env.GOOGLE_CALENDAR_CREDENTIALS != '' }}
        env:
          GOOGLE_CALENDAR_CREDENTIALS: ${{ secrets.GOOGLE_CALENDAR_CREDENTIALS }}
        run: |
          echo "${GOOGLE_CALENDAR_CREDENTIALS}" | base64 -d > ~/.connpass-watcher/credentials.json

      - name: Setup Google Calendar tokens
        if: ${{ env.GOOGLE_CALENDAR_TOKENS != '' }}
        env:
          GOOGLE_CALENDAR_TOKENS: ${{ secrets.GOOGLE_CALENDAR_TOKENS }}
        run: |
          echo "${GOOGLE_CALENDAR_TOKENS}" | base64 -d > ~/.connpass-watcher/tokens.json

      - name: Restore database cache
        uses: actions/cache@v4
        with:
          path: ~/.connpass-watcher/events.db
          key: connpass-db-${{ github.run_id }}
          restore-keys: |
            connpass-db-

      - name: Run scan
        shell: bash
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            node dist/index.js scan --dry-run --json > scan-results.json
          else
            node dist/index.js scan --json > scan-results.json
          fi

      - name: Display results
        run: |
          echo "=== Scan Results ==="
          jq '.' scan-results.json

      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: scan-results-${{ github.run_id }}
          path: scan-results.json
          retention-days: 30

      - name: Save updated tokens
        if: ${{ always() }}
        run: |
          if [ -f ~/.connpass-watcher/tokens.json ]; then
            echo "Updated tokens (base64):"
            base64 < ~/.connpass-watcher/tokens.json
          fi
